var T=Object.defineProperty;var U=(n,r,e)=>r in n?T(n,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[r]=e;var s=(n,r,e)=>(U(n,typeof r!="symbol"?r+"":r,e),e);import{R as M,S as w,V as f,c as p,I as E,a as b}from"./index.bd7c4339.js";class N{constructor(){s(this,"events",new M)}getScreenInfo(){throw k("screen info")}setScreenInfo(r){throw k("screen info")}async destroy(){this.events.destroy()}}function k(n){return new Error(`Does not support ${n}`)}class x{constructor(){s(this,"sideEffect",new w);s(this,"events",new M)}async destroy(){this.sideEffect.flushAll(),this.events.destroy()}async setSpeakerVolume(r){throw v("setting speaker volume")}startNetworkTest(){throw v("network probe test")}stopNetworkTest(){throw v("network probe test")}startCameraTest(r){throw v("camera test")}stopCameraTest(){throw v("camera test")}startMicTest(){throw v("microphone test")}stopMicTest(){throw v("microphone test")}startSpeakerTest(r){throw v("speaker test")}stopSpeakerTest(){throw v("speaker test")}}function v(n){return new Error(`Does not support ${n}`)}var B=(n=>(n[n.Communication=0]="Communication",n[n.Broadcast=1]="Broadcast",n[n.Gaming=2]="Gaming",n))(B||{}),H=(n=>(n[n.Host=1]="Host",n[n.Audience=2]="Audience",n))(H||{});class L{constructor(r){s(this,"uid");s(this,"_rtc");s(this,"_sideEffect",new w);s(this,"_active$",new f(!1));s(this,"_shouldCamera$",new f(!1));s(this,"_shouldMic$",new f(!1));s(this,"_el$");this._rtc=r.rtc,this._el$=new f(r.element),this.uid=r.uid,this._sideEffect.addDisposer(p([this._el$,this._active$]).subscribe(([e,i])=>{if(e&&i)try{this._rtc.rtcEngine.setupRemoteVideo(Number(this.uid),e)}catch(a){console.error(a)}})),this._sideEffect.addDisposer(p([this._el$,this._active$,this._shouldMic$]).subscribe(([e,i,a])=>{try{this._rtc.rtcEngine.muteRemoteAudioStream(Number(this.uid),!(e&&i&&a))}catch(t){console.error(t)}})),this._sideEffect.addDisposer(p([this._el$,this._active$,this._shouldCamera$]).subscribe(([e,i,a])=>{try{this._rtc.rtcEngine.muteRemoteVideoStream(Number(this.uid),!(e&&i&&a))}catch(t){console.error(t)}})),this._sideEffect.addDisposer(()=>{this._active$.setValue(!1)})}setActive(r){this._active$.setValue(r)}enableCamera(r){this._shouldCamera$.setValue(r)}enableMic(r){this._shouldMic$.setValue(r)}setElement(r){this._el$.setValue(r)}getVolumeLevel(){return this._rtc.getVolumeLevel(this.uid)||0}destroy(){this._sideEffect.flushAll()}}class O{constructor(r){s(this,"_rtc");s(this,"_sideEffect",new w);s(this,"_shouldCamera$",new f(!1));s(this,"_shouldMic$",new f(!1));s(this,"_el$");this._rtc=r.rtc,this._el$=new f(r.element),this._sideEffect.addDisposer(this._el$.subscribe(e=>{try{e?((this._shouldCamera$.value||this._shouldMic$.value)&&this._rtc.setRole(E.Host),this._rtc.rtcEngine.setupLocalVideo(e),this._rtc.rtcEngine.enableLocalAudio(this._shouldMic$.value),this._rtc.rtcEngine.enableLocalVideo(this._shouldCamera$.value)):(this._rtc.rtcEngine.enableLocalAudio(!1),this._rtc.rtcEngine.enableLocalVideo(!1),this._rtc.setRole(E.Audience))}catch(i){console.error(i)}})),this._sideEffect.addDisposer(this._shouldMic$.reaction(e=>{if(this._el$.value)try{e?(this._rtc.setRole(E.Host),this._rtc.rtcEngine.enableLocalAudio(!0)):(this._rtc.rtcEngine.enableLocalAudio(!1),this._shouldCamera$.value||this._rtc.setRole(E.Audience))}catch(i){console.error(i)}})),this._sideEffect.addDisposer(this._shouldCamera$.reaction(e=>{if(this._el$.value)try{e?(this._rtc.setRole(E.Host),this._rtc.rtcEngine.enableLocalVideo(!0)):(this._rtc.rtcEngine.enableLocalVideo(!1),this._shouldMic$.value||this._rtc.setRole(E.Audience))}catch(i){console.error(i)}})),this._sideEffect.addDisposer(()=>{this._rtc.rtcEngine.enableLocalVideo(!1),this._rtc.rtcEngine.enableLocalAudio(!1),this._el$.setValue(null)})}enableCamera(r){this._shouldCamera$.setValue(r)}enableMic(r){this._shouldMic$.setValue(r)}setElement(r){this._el$.setValue(r)}getVolumeLevel(){return this._rtc.getVolumeLevel()||0}destroy(){this._sideEffect.flushAll()}}const C={x:0,y:0,width:0,height:0},P={width:0,height:0,bitrate:0,frameRate:15,captureMouseCursor:!0,windowFocus:!1,excludeWindowList:[],excludeWindowCount:0};class W extends N{constructor(e){var i;super();s(this,"_rtc");s(this,"_sideEffect",new w);s(this,"_params$",new f(null));s(this,"_enabled$",new f(!1));s(this,"_active$",new f(!1));s(this,"_el$");s(this,"_screenInfo$",new f(null));s(this,"_pTogglingShareScreen");s(this,"_lastEnabled",!1);this._rtc=e.rtc,this._el$=new f((i=e.element)!=null?i:null),this._sideEffect.addDisposer(p([this._active$,this._params$,this._el$]).subscribe(([a,t,l])=>{if(l&&t){const d=Number(t.uid);try{a?(this.client.muteRemoteVideoStream(d,!1),this.client.setupRemoteVideo(d,l),this.client.setupViewContentMode(d,1,void 0)):(this.client.destroyRender(d,void 0),this.client.destroyRenderView(d,void 0,l)),this.events.emit("remote-changed",a)}catch(o){console.error(o)}}this.events.emit("remote-changed",a)})),this._sideEffect.addDisposer(p([this._screenInfo$,this._enabled$]).subscribe(async([a,t])=>{try{a&&t?await this.enableShareScreen(a):await this.disableShareScreen(),this.events.emit("local-changed",t)}catch(l){this.events.emit("err-enable",l)}}))}get client(){return this._rtc.rtcEngine}shouldSubscribeRemoteTrack(){return!this._enabled$.value}setActive(e){this._active$.setValue(e)}setParams(e){this._params$.setValue(e)}async getScreenInfo(){await new Promise(t=>setTimeout(t,100));const e=await new Promise(t=>this.client.getScreenDisplaysInfo(t)),i=await new Promise(t=>this.client.getScreenWindowsInfo(t)),a=t=>t.image?"displayId"in t?{type:"display",screenId:t.displayId,name:"Desktop",image:t.image,width:t.width,height:t.height}:{type:"window",screenId:t.windowId,name:`${t.ownerName} - ${t.name}`,image:t.image,width:t.originWidth,height:t.originHeight}:null;return j([...e.map(a),...i.map(a)])}setScreenInfo(e){this._screenInfo$.setValue(e)}enable(e){if(this._el$.value&&this._active$.value)throw new Error("There already exists remote screen track.");this._enabled$.setValue(e)}setElement(e){this._el$.setValue(e)}async destroy(){super.destroy(),this._sideEffect.flushAll()}async enableShareScreen(e){if(!this._params$.value)throw new Error("Should call joinRoom() before share screen.");if(this._lastEnabled===!0)return;this._lastEnabled=!0,this._pTogglingShareScreen&&await this._pTogglingShareScreen;const{roomUUID:i,token:a,uid:t}=this._params$.value;this._pTogglingShareScreen=new Promise(l=>{this.client.once("videoSourceJoinedSuccess",()=>{this.client.videoSourceSetVideoProfile(43,!1),e.type==="display"?this.client.videoSourceStartScreenCaptureByScreen(e.screenId,C,P):this.client.videoSourceStartScreenCaptureByWindow(e.screenId,C,P),l()}),this.client.videoSourceInitialize(this._rtc.APP_ID),this.client.videoSourceSetChannelProfile(1),this.client.videoSourceJoin(a,i,"",Number(t))}),await this._pTogglingShareScreen,this._pTogglingShareScreen=void 0}async disableShareScreen(){this._pTogglingShareScreen&&await this._pTogglingShareScreen,this._lastEnabled!==!1&&(this._lastEnabled=!1,this._pTogglingShareScreen=new Promise(e=>{this.client.once("videoSourceLeaveChannel",()=>{this.client.videoSourceRelease(),e()}),this.client.videoSourceLeave()}),await this._pTogglingShareScreen,this._pTogglingShareScreen=void 0)}}function j(n){return n.filter(Boolean)}const A=class extends x{constructor(e){super();s(this,"shareScreen",new W({rtc:this}));s(this,"APP_ID");s(this,"rtcEngine");s(this,"_roomSideEffect",new w);s(this,"_cameraID");s(this,"_micID");s(this,"_speakerID");s(this,"uid");s(this,"roomUUID");s(this,"mode");s(this,"shareScreenUID");s(this,"_volumeLevels",new Map);s(this,"_remoteAvatars",new Map);s(this,"_localAvatar");this.APP_ID=e.APP_ID,this.rtcEngine=e.rtcEngine,this._init(this.rtcEngine)}get remoteAvatars(){return[...this._remoteAvatars.values()]}get localAvatar(){var e;return(e=this._localAvatar)!=null?e:this._localAvatar=new O({rtc:this})}get isJoinedRoom(){return Boolean(this.roomUUID)}setRTCEngine(e){this.rtcEngine=e,this._init(e)}_init(e){this.sideEffect.add(()=>{const i=()=>{var o;try{return(o=e.getCurrentAudioPlaybackDevice())==null?void 0:o.deviceid}catch(g){console.error(g);return}},a=()=>{var o;try{return(o=e.getCurrentAudioRecordingDevice())==null?void 0:o.deviceid}catch(g){console.error(g);return}},t=()=>{var o;try{return(o=e.getCurrentVideoDevice())==null?void 0:o.deviceid}catch(g){console.error(g);return}};this._cameraID=t(),this._micID=a(),this._speakerID=i();const l=()=>{const o=a(),g=i();o&&this.setMicID(o),g&&this.setSpeakerID(g)},d=()=>{const o=t();o&&this.setCameraID(o)};return e.on("audioDeviceStateChanged",l),e.on("videoDeviceStateChanged",d),()=>{e.off("audioDeviceStateChanged",l),e.off("videoDeviceStateChanged",d)}},"init"),this.sideEffect.add(()=>{const i=(a,t)=>{this.events.emit("error",new Error(t))};return e.on("error",i),()=>e.off("error",i)})}async destroy(){super.destroy(),this.sideEffect.flushAll(),await this.leaveRoom()}async joinRoom(e){if(!this.rtcEngine)throw new Error("AgoraRTC is not provided");if(this.roomUUID){if(this.roomUUID===e.roomUUID)return;this.leaveRoom()}return this._join(e)}async leaveRoom(){this.roomUUID&&(this.rtcEngine.leaveChannel(),this.rtcEngine.videoSourceLeave()),this._roomSideEffect.flushAll(),this.uid=void 0,this.roomUUID=void 0,this.mode=void 0,this.shareScreenUID=void 0,this.shareScreen.setActive(!1),this.shareScreen.setParams(null)}getAvatar(e){if(!this.isJoinedRoom)return;if(!e||e==="0"||this.uid===e)return this.localAvatar;if(this.shareScreenUID===e)throw new Error("getAvatar(shareScreenUID) is not supported.");let i=this._remoteAvatars.get(e);return i||(i=new L({rtc:this,uid:e}),this._remoteAvatars.set(e,i)),i}getTestAvatar(){return this.localAvatar}getVolumeLevel(e){return this._volumeLevels.get(e||"0")||0}async setRole(e){this.rtcEngine&&this.mode===b.Broadcast&&this.rtcEngine.setClientRole(e===E.Host?1:2)}getCameraID(){return this._cameraID}async setCameraID(e){this._cameraID!==e&&(this.rtcEngine.setVideoDevice(e),this._cameraID=e,this.events.emit("camera-changed",e))}async getCameraDevices(){return this.rtcEngine.getVideoDevices().map(e=>({deviceId:e.deviceid,label:e.devicename}))}getMicID(){return this._micID}async setMicID(e){this._micID!==e&&(this.rtcEngine.setAudioRecordingDevice(e),this._micID=e,this.events.emit("mic-changed",e))}async getMicDevices(){return this.rtcEngine.getAudioRecordingDevices().map(e=>({deviceId:e.deviceid,label:e.devicename}))}getSpeakerID(){return this._speakerID}async setSpeakerID(e){this._speakerID!==e&&(this._speakerID=e,this.rtcEngine.setAudioPlaybackDevice(e),this.events.emit("speaker-changed",e))}async getSpeakerDevices(){return this.rtcEngine.getAudioPlaybackDevices().map(e=>({deviceId:e.deviceid,label:e.devicename}))}getSpeakerVolume(){return this.rtcEngine.getAudioPlaybackVolume()/255||0}async setSpeakerVolume(e){e=Math.max(0,Math.min(e,1)),this.rtcEngine.setAudioPlaybackVolume(Math.ceil(e*255))}startNetworkTest(){this.sideEffect.add(()=>{const e=this.rtcEngine,i=a=>{this.events.emit("network-test",a)};return e.on("lastMileQuality",i),()=>e.off("lastMileQuality",i)},"network-test"),this.rtcEngine.startLastmileProbeTest({expectedDownlinkBitrate:1e5,expectedUplinkBitrate:1e5,probeDownlink:!0,probeUplink:!0})}stopNetworkTest(){this.rtcEngine.stopLastmileProbeTest(),this.sideEffect.flush("network-test")}startCameraTest(e){this.rtcEngine.enableVideo();const i=this.localAvatar;i.setElement(e),i.enableCamera(!0),i.enableMic(!0),this.rtcEngine.startPreview()}stopCameraTest(){const e=this.localAvatar;e.setElement(null),e.enableCamera(!1),e.enableMic(!1),this.rtcEngine.stopPreview(),this.rtcEngine.disableVideo()}startMicTest(){this.rtcEngine.startAudioRecordingDeviceTest(300),this.sideEffect.add(()=>{const e=this.rtcEngine,i=(a,t,l)=>{this.events.emit("volume-level-changed",l/255)};return e.on("groupAudioVolumeIndication",i),()=>e.off("groupAudioVolumeIndication",i)},"mic-test")}stopMicTest(){this.rtcEngine.stopAudioRecordingDeviceTest(),this.sideEffect.flush("mic-test")}startSpeakerTest(e){this.rtcEngine.enableAudio(),this.rtcEngine.enableLocalAudio(!0),this.rtcEngine.startAudioPlaybackDeviceTest(e)}stopSpeakerTest(){this.rtcEngine.stopAudioPlaybackDeviceTest(),this.rtcEngine.enableLocalAudio(!1),this.rtcEngine.disableAudio()}async _join({uid:e,token:i,mode:a,refreshToken:t,role:l,roomUUID:d,shareScreenUID:o,shareScreenToken:g}){this._roomSideEffect.flushAll(),this.shareScreenUID=o;const I=a===b.Broadcast?1:0;this.rtcEngine.setChannelProfile(I),this.rtcEngine.videoSourceSetChannelProfile(I),this.rtcEngine.setVideoEncoderConfiguration({bitrate:0,degradationPreference:1,frameRate:15,minBitrate:-1,minFrameRate:-1,mirrorMode:0,orientationMode:0,height:216,width:288}),a===b.Broadcast&&this.rtcEngine.setClientRole(l===E.Host?1:2),this.rtcEngine.enableVideo(),this.rtcEngine.enableAudio(),this.rtcEngine.enableLocalVideo(!1),this.rtcEngine.enableLocalAudio(!1),t&&this._roomSideEffect.add(()=>{const h=async()=>{const m=await t(d);this.rtcEngine.renewToken(m)};return this.rtcEngine.on("tokenPrivilegeWillExpire",h),()=>this.rtcEngine.off("tokenPrivilegeWillExpire",h)}),this._roomSideEffect.add(()=>{let h=0;const m=u=>{u.forEach(({uid:S,volume:_})=>{if(_=_/255,S===0){const D=this._volumeLevels.get("0")||0;this._volumeLevels.set(String(S),_),this.uid&&this._volumeLevels.set(this.uid,_),Math.abs(D-_)>1e-5&&this.events.emit("volume-level-changed",D),_<=A.LOW_VOLUME_LEVEL_THRESHOLD?++h>=10&&this.events.emit("err-low-volume"):h=0}else this._volumeLevels.set(String(S),_)})},c=u=>{this._volumeLevels.delete(String(u))};return this.rtcEngine.on("groupAudioVolumeIndication",m),this.rtcEngine.on("userOffline",c),this.rtcEngine.off("userMuteAudio",c),()=>{this.rtcEngine.off("groupAudioVolumeIndication",m),this.rtcEngine.off("userOffline",c),this.rtcEngine.off("userMuteAudio",c)}}),this._roomSideEffect.add(()=>{const h=m=>{const c=String(m);if(this.shareScreenUID===c&&this.shareScreen.shouldSubscribeRemoteTrack()){this.shareScreen.setActive(!0);return}let u=this._remoteAvatars.get(c);u||(u=new L({rtc:this,uid:c}),this._remoteAvatars.set(c,u)),u.setActive(!0)};return this.rtcEngine.on("userJoined",h),()=>this.rtcEngine.off("userJoined",h)}),this._roomSideEffect.add(()=>{const h=m=>{const c=String(m);if(this.shareScreenUID===c){this.shareScreen.setActive(!1);return}const u=this._remoteAvatars.get(c);u&&(u.destroy(),this._remoteAvatars.delete(c))};return this.rtcEngine.on("userOffline",h),()=>this.rtcEngine.off("userOffline",h)}),this._roomSideEffect.addDisposer(this.events.remit("network",()=>{let h=0,m=0,c=NaN;const u=(_,D,R)=>{const $=String(_);($==="0"||$===this.uid)&&(h=D,m=R,this.events.emit("network",{uplink:h,downlink:m,delay:c}))},S=_=>{c=_.lastmileDelay,this.events.emit("network",{uplink:h,downlink:m,delay:c})};return this.rtcEngine.on("rtcStats",S),this.rtcEngine.on("networkQuality",u),()=>{this.rtcEngine.off("rtcStats",S),this.rtcEngine.off("networkQuality",u)}}));const V=i||await(t==null?void 0:t(d));if(!V)throw new Error("No join room token provided");if(this.rtcEngine.joinChannel(V,d,"",Number(e))<0)throw new Error("[RTC]: join channel failed");this.rtcEngine.enableAudioVolumeIndication(500,3),this.uid=e,this.roomUUID=d,this.shareScreenUID=o,this.mode=a,this.shareScreen.setParams({roomUUID:d,token:g,uid:o})}};let y=A;s(y,"LOW_VOLUME_LEVEL_THRESHOLD",1e-5);export{y as AgoraRTCElectron,B as FlatRTCAgoraElectronMode,H as FlatRTCAgoraElectronRole};
//# sourceMappingURL=index.a46b16f7.js.map
